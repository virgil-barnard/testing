(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const A of a.addedNodes)A.tagName==="LINK"&&A.rel==="modulepreload"&&e(A)}).observe(document,{childList:!0,subtree:!0});function i(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(o){if(o.ep)return;o.ep=!0;const a=i(o);fetch(o.href,a)}})();const G=document.getElementById("canvas"),y=document.getElementById("video");document.getElementById("info");const ue=await navigator.gpu.requestAdapter(),t=await ue.requestDevice(),z=G.getContext("webgpu"),L=navigator.gpu.getPreferredCanvasFormat();z.configure({device:t,format:L});await(async()=>{const r=await navigator.mediaDevices.getUserMedia({video:!0});y.srcObject=r,await new Promise(n=>y.onloadedmetadata=n),G.width=y.videoWidth,G.height=y.videoHeight})();const u=[G.width,G.height],c=GPUTextureUsage.TEXTURE_BINDING,l=GPUTextureUsage.STORAGE_BINDING,U=GPUTextureUsage.RENDER_ATTACHMENT,b=GPUTextureUsage.COPY_DST,ce=GPUTextureUsage.COPY_SRC,s=(r,n="rgba8unorm",i=u)=>t.createTexture({size:i,format:n,usage:r}),m=t.createSampler({magFilter:"linear",minFilter:"linear"}),C=3,d=Array.from({length:C},(r,n)=>[Math.max(1,u[0]>>n),Math.max(1,u[1]>>n)]);let P=d.map(r=>s(c|U|b,"bgra8unorm",r)),g=d.map(r=>s(c|U|b,"bgra8unorm",r)),f=d.map(r=>s(c|l|b,"rgba16float",r));const h=s(c|b|U),_=s(c|l),j=s(c|l),H=s(c|l|U),X=s(c|l),$=s(c|l),V=s(c|l|ce,"rgba8unorm",u);let R=new Float32Array(9).fill(.1);const x=t.createTexture({size:[3,3],format:"r32float",usage:c|b});t.queue.writeTexture({texture:x},R,{bytesPerRow:3*4},[3,3]);const F=t.createRenderPipeline({layout:"auto",vertex:{module:blurMod,entryPoint:"vs_main"},fragment:{module:blurMod,entryPoint:"fs_main",targets:[{format:L}]},primitive:{topology:"triangle-strip"}}),K=t.createComputePipeline({layout:"auto",compute:{module:upscaleMod,entryPoint:"main"}}),J=t.createComputePipeline({layout:"auto",compute:{module:flowMod,entryPoint:"main"}}),w=t.createComputePipeline({layout:"auto",compute:{module:cnnMod,entryPoint:"main"}}),v=t.createComputePipeline({layout:"auto",compute:{module:augMod,entryPoint:"main"}}),Q=t.createComputePipeline({layout:"auto",compute:{module:warpMod,entryPoint:"main"}}),Z=t.createComputePipeline({layout:"auto",compute:{module:lossMod,entryPoint:"main"}}),B=t.createBuffer({size:9*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),M=t.createBuffer({size:9*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});function q(r=32){return t.createBuffer({size:r,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}const ee=q(),te=q(),re=q(16),T=t.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});new Float32Array(T.getMappedRange()).set(u);T.unmap();function se(r,n){return t.createBindGroup({layout:K.getBindGroupLayout(0),entries:[{binding:0,resource:r.createView()},{binding:1,resource:m},{binding:2,resource:n.createView()}]})}function de(r,n,i,e){return t.createBindGroup({layout:J.getBindGroupLayout(0),entries:[{binding:0,resource:r.createView()},{binding:1,resource:n.createView()},{binding:2,resource:e.createView()}]})}function I(r,n){const i=t.createCommandEncoder(),e=i.beginRenderPass({colorAttachments:[{view:n.createView(),loadOp:"clear",storeOp:"store",clearValue:[0,0,0,1]}]}),o=t.createBindGroup({layout:F.getBindGroupLayout(0),entries:[{binding:0,resource:m},{binding:1,resource:r.createView()}]});e.setPipeline(F),e.setBindGroup(0,o),e.draw(4),e.end(),t.queue.submit([i.finish()])}const S=await mod("/src/shaders/overlay.wgsl"),ne=t.createRenderPipeline({layout:"auto",vertex:{module:S,entryPoint:"vs_main"},fragment:{module:S,entryPoint:"fs_main",targets:[{format:L}]},primitive:{topology:"triangle-strip"}}),N=s(c|l,"rgba8unorm"),D=s(c|b,"rgba8unorm",u),le=await mod("/src/shaders/temp_consistency.wgsl"),oe=t.createComputePipeline({layout:"auto",compute:{module:le,entryPoint:"main"}}),pe=await mod("/src/shaders/temp_loss.wgsl"),ie=t.createComputePipeline({layout:"auto",compute:{module:pe,entryPoint:"main"}});function me(r,n,i){return t.createBindGroup({layout:oe.getBindGroupLayout(0),entries:[{binding:0,resource:r.createView()},{binding:1,resource:n.createView()},{binding:2,resource:i.createView()},{binding:3,resource:m}]})}function ge(r,n,i){return t.createBindGroup({layout:ie.getBindGroupLayout(0),entries:[{binding:0,resource:r.createView()},{binding:1,resource:n.createView()},{binding:2,resource:{buffer:i}}]})}function fe(){return t.createBindGroup({layout:ne.getBindGroupLayout(0),entries:[{binding:0,resource:m},{binding:1,resource:h.createView()},{binding:2,resource:V.createView()}]})}const ye=t.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:ee}},{binding:1,resource:m},{binding:2,resource:h.createView()},{binding:3,resource:_.createView()}]}),we=t.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:te}},{binding:1,resource:m},{binding:2,resource:h.createView()},{binding:3,resource:j.createView()}]}),be=t.createBindGroup({layout:w.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:T}},{binding:1,resource:_.createView()},{binding:2,resource:x.createView()},{binding:3,resource:H.createView()}]}),Pe=t.createBindGroup({layout:w.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:T}},{binding:1,resource:j.createView()},{binding:2,resource:x.createView()},{binding:3,resource:X.createView()}]}),Be=t.createBindGroup({layout:Q.getBindGroupLayout(0),entries:[{binding:0,resource:X.createView()},{binding:1,resource:$.createView()},{binding:2,resource:{buffer:re}},{binding:3,resource:m}]}),Ge=t.createBindGroup({layout:Z.getBindGroupLayout(0),entries:[{binding:0,resource:H.createView()},{binding:1,resource:$.createView()},{binding:2,resource:_.createView()},{binding:3,resource:{buffer:B}}]});function W(){const r=.6+Math.random()*.3,n=Math.random()*(1-r),i=Math.random()*(1-r),e=()=>.1+Math.random()*.8;return new Float32Array([n,i,r,r,e(),e(),e(),0])}function p(r,n,i){r.setPipeline(n),r.setBindGroup(0,i),r.dispatchWorkgroups(Math.ceil(u[0]/8),Math.ceil(u[1]/8))}const he=10,xe=.01,Te=1e6;function Me(){const n=(Math.random()-.5)*.2,i=(Math.random()-.5)*.2,e=1,o=1;return new Float32Array([n,i,e,o])}async function Ce(){const r=t.createCommandEncoder();r.copyBufferToBuffer(B,0,M,0,B.size),t.queue.submit([r.finish()]),await M.mapAsync(GPUMapMode.READ);const n=new Int32Array(M.getMappedRange());let i=0;for(let e=0;e<9;e++){const o=n[e]/Te;i+=Math.abs(o),R[e]-=xe*o}M.unmap(),t.queue.writeTexture({texture:x},R,{bytesPerRow:3*4},[3,3]),t.queue.writeBuffer(B,0,new Float32Array(9).fill(0)),Re.textContent=i.toExponential(3)}let Ve=0,Y=performance.now(),E=0,k=performance.now(),O=0;const ve=document.getElementById("video-fps"),Ue=document.getElementById("inference-fps");function Ae(){++E&&performance.now()-Y>=1e3&&(ve.textContent=`${E}`,E=0,Y=performance.now())}function Ee(){++O&&performance.now()-k>=1e3&&(Ue.textContent=`${O}`,O=0,k=performance.now())}const Oe=t.createBindGroup({layout:w.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:T}},{binding:1,resource:h.createView()},{binding:2,resource:x.createView()},{binding:3,resource:V.createView()}]});let Re=document.getElementById("grad-l1");function ae(){Ae(),t.queue.copyExternalImageToTexture({source:y},{texture:h},u),t.queue.copyExternalImageToTexture({source:y},{texture:g[0]},u);for(let e=1;e<C;e++)I(g[e-1],g[e]),I(P[e-1],P[e]);for(let e=C-1;e>=0;e--){const o=t.createCommandEncoder(),a=o.beginComputePass();e<C-1?(a.setPipeline(K),a.setBindGroup(0,se(f[e+1],f[e])),a.dispatchWorkgroups(Math.ceil(d[e][0]/8),Math.ceil(d[e][1]/8))):t.queue.writeTexture({texture:f[e]},new Float32Array(d[e][0]*d[e][1]*4).fill(0),{bytesPerRow:d[e][0]*16},d[e]),a.setPipeline(J),a.setBindGroup(0,de(P[e],g[e],f[e],f[e])),a.dispatchWorkgroups(Math.ceil(d[e][0]/8),Math.ceil(d[e][1]/8)),a.end(),t.queue.submit([o.finish()])}{const e=t.createCommandEncoder(),o=e.beginComputePass();o.setPipeline(oe),o.setBindGroup(0,me(D,f[0],N)),o.dispatchWorkgroups(Math.ceil(u[0]/8),Math.ceil(u[1]/8)),o.end(),t.queue.submit([e.finish()])}{const e=t.createCommandEncoder(),o=e.beginComputePass();o.setPipeline(ie),o.setBindGroup(0,ge(V,N,B)),o.dispatchWorkgroups(Math.ceil(u[0]/8),Math.ceil(u[1]/8)),o.end(),t.queue.submit([e.finish()])}t.queue.writeBuffer(ee,0,W()),t.queue.writeBuffer(te,0,W()),t.queue.writeBuffer(re,0,Me());const r=t.createCommandEncoder(),n=r.beginComputePass();p(n,v,ye),p(n,v,we),p(n,w,be),p(n,w,Pe),p(n,Q,Be),p(n,Z,Ge),p(n,w,Oe),n.end();const i=r.beginRenderPass({colorAttachments:[{view:z.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store",clearValue:[0,0,0,1]}]});i.setPipeline(ne),i.setBindGroup(0,fe()),i.draw(4),i.end(),t.queue.submit([r.finish()]);{const e=t.createCommandEncoder();e.copyTextureToTexture({texture:V},{texture:D},u),t.queue.submit([e.finish()])}Ee(),++Ve%he===0&&Ce().catch(console.error),[g,P]=[P,g],requestAnimationFrame(ae)}requestAnimationFrame(ae);
